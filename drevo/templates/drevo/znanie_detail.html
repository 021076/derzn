{% extends 'base.html' %}
{% load mptt_tags %}
{% load static %}

{% block title %}Знание: {{ znanie.name }}{% endblock %}

{% block content %}

{% if znanie.category.pk %}
<h6><a href="{% url 'drevo_type' znanie.category.pk %}"><<< {{ znanie.category }}</a></h6>
{% endif %}

<h1>{{ znanie.name }}</h1>

<div class="container">
  <div class="row">
    <div class="col">
      Вид знания: {{ znanie.tz }}
    </div>
    <div class="col">
        {% if znanie.author %}
            Автор: <a href="{% url 'author' znanie.author.pk %}">{{ znanie.author }}</a>
        {% else %}
            Автор: не указан
        {% endif %}
    </div>
    <div class="col">
      Дата: {{ znanie.date }}
    </div>
  </div>
</div>


{% if znanie.content %}
<hr>
<div class="container">
  <div class="row">
    <div class="col">
      Содержание: {{ znanie.content|safe }}
    </div>
  </div>
</div>
{% endif %}

{% if znanie.href %}
<hr>
<div class="container">
  <div class="row">
    <div class="col">
      <a href="{{ znanie.href }}">Источник</a>
    </div>
    {% if znanie.source_com %}
    <div class="col">
      Комментарий к источнику: {{ znanie.source_com }}
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

{% if visits %}
<hr>
<div class="container">
  <div class="row">
    <div class="col">
        Число просмотров: {{ visits }}
    </div>
  </div>
</div>
{% endif %}

<hr>
<div class="container">
    <div class="row mb-2">
        <div class="col">
            <div class="d-flex">
                <div class="button-block mx-3" style="white-space: nowrap">
                    <button type="button" id="likeButton" class="btn btn-outline-secondary shadow-none mx-1"
                            {% if not user.is_authenticated %} data-bs-toggle="modal" data-bs-target="#authModal" {% endif %}>
                        <i class="bi {% if user_vote.like %} bi-hand-thumbs-up-fill {% else %} bi-hand-thumbs-up {% endif %} fs-5"
                           id="likeIcon"></i>
                    </button>
                    <span id="likesCounter">{{ znanie.get_likes_count }}</span>
                </div>
                <div class="mx-3" style="white-space: nowrap">
                    <button type="button" id="dislikeButton" class="btn btn-outline-secondary shadow-none mx-1"
                            {% if not user.is_authenticated %} data-bs-toggle="modal" data-bs-target="#authModal" {% endif %}>
                        <i class="bi {% if user_vote.dislike %} bi-hand-thumbs-down-fill {% else %} bi-hand-thumbs-down {% endif %} fs-5"
                           id="dislikeIcon"></i>
                    </button>
                    <span id="dislikesCounter">{{ znanie.get_dislikes_count }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно -->
<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="authModalLabel">Требуется авторизация</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        Войдите в свой аккаунт, чтобы поставить отметку.
      </div>
      <div class="modal-footer">
        <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary">Войти</a>
        <a href="{% url 'users:register' %}" class="btn btn-secondary">Зарегистрироваться</a>
      </div>
    </div>
  </div>
</div>

{% if znanie.labels.all %}
<hr>
<div class="container">
  <div class="row">
    <div class="col">
        Метки: {% for label in znanie.labels.all %} #<a href="{% url 'zlabel' label.pk %}">{{ label }}</a> {% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% if znanie.photos.all %}
<hr>
<div class="container">
  <div class="row">
    <div class="col">
        {% for photo in znanie.photos.all %} <a href="{{ MEDIA_URL }}{{ photo.photo }}"><img src="{{ MEDIA_URL }}{{ photo.photo }}" height="150"></a>&nbsp;&nbsp;&nbsp;{% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% for c in categories %}
<ul>
  <li>  
  {% if c == category %} <a href="{{ c.get_absolute_url }}" class="fw-bold">{{ c.name }} </a>
  {% else %} <a href="{{ c.get_absolute_url }}">{{ c.name }} </a>
  {% endif %}
  </li>
{% endfor %}

  {# Цепочка знаний #}
  {% for z in chain %}
    <ul>
      <li>  
      <a href="{{ z.get_absolute_url }}">{{ z.name }} </a>
    </li>
    {% empty %}
    <div class="container">
      <div class='row'>
      &nbsp;
      </div>
    </div>
    {% endfor %}

    {# Текущее знание, без ссылки #}
    <ul>
      <li>  
      <p class='fw-bold'>{{ znanie.name }}</p>
    </li>

        {# Дети текущего знания, сгруппированные по видам связей #}
        {% if children_by_tr %}
        <ul>
          {% for rel_type, children in children_by_tr.items %}
          <li>  {{ rel_type }}
            <ul>
            {% for child in children %}
            <li>
              {{ child.tz }}&#10000;<a href="{{ child.get_absolute_url }}">{{ child.name }} </a>, 
              {{ child.author|default_if_none:'автор не указан' }}
            </li>
            {% endfor %}
            </ul>
        </li>
          {% endfor %}
        </ul>
        {% endif %}

    </ul>

    {# Братья/сёстры текущего знания #}
    {% if siblings %}
    <ul>
      {% for s in siblings %}
      <li>  
        <a href="{{ s.get_absolute_url }}">{{ s.name }} </a>
    </li>
      {% endfor %}
    </ul>
    {% endif %}


    {# Закрывающие теги для дерева предков #}
    {% for z in chain %}
    </ul>
   {% endfor %}

{# Закрывающие теги для дерева категорий #}
{% for c in categories %}
</ul>
{% endfor %}


{% if rels %}
<table class="table">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">Связанное знание</th>
      <th scope="col">Вид знания</th>
      <th scope="col">Автор</th>
    </tr>
  </thead>
  <tbody>
<br/><br/>

{% for item in rels %}
<tr>
  <td colspan="3">
<h3>{{ item.0 }}</h3>
  </td>
</tr>
 {% for z in item.1 %}
    <tr>
      <th scope="row">{{ forloop.counter }}</th>
      <td><a href="{% url 'zdetail' z.rz.pk %}">{{ z.rz }}</a></td>
      <td> {{ z.rz.tz }}</td>
      <td> {{ z.rz.author }}</td>
    </tr>
  {% empty %}
  <tr>
    <td colspan="3">
  <h5>данных нет</h5>
    </td>
  </tr>
  {% endfor %}

  {% empty %}
  <tr>
    <td colspan="3">
  <h5>данных нет</h5>
    </td>
  </tr>
{% endfor %}

  </tbody>
</table>

{% endif %}

{% endblock %}

{% block jsfiles %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'drevo/js/rating.js' %}"></script>
{% endblock %}
